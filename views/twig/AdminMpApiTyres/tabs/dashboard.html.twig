{# Dashboard Catalogo Prodotti Prestashop 8 #} 
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>

<style>
    .grow {
        flex-grow: 1;
    }
</style>

<div class="card">
    <div class="card-body d-flex justify-content-between align-items-center gap-4">
        <!-- Statistiche rapide -->
        <div class="mb-3 grow">
            <div class="card shadow-sm border-0">
                <div class="card-body d-flex align-items-center">
                    <span class="material-icons mr-3 text-primary" style="font-size: 2.5rem">inventory_2</span>
                    <div>
                        <h6 class="mb-0">Prodotti Totali</h6>
                        <h3 class="mb-0">{{ total_products }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-3 grow">
            <div class="card shadow-sm border-0">
                <div class="card-body d-flex align-items-center">
                    <span class="material-icons mr-3 text-success" style="font-size: 2.5rem">category</span>
                    <div>
                        <h6 class="mb-0">Categorie</h6>
                        <h3 class="mb-0">{{ total_categories }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-3 grow">
            <div class="card shadow-sm border-0">
                <div class="card-body d-flex align-items-center">
                    <span class="material-icons mr-3 text-warning" style="font-size: 2.5rem">layers</span>
                    <div>
                        <h6 class="mb-0">Quantità Totale</h6>
                        <h3 class="mb-0">{{ total_quantity }}</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card-body d-flex justify-content-between align-items-center gap-4">
        <!-- Ultimi prodotti inseriti -->
        <div class="grow">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-0 d-flex align-items-center">
                    <span class="material-icons mr-2 text-info">new_releases</span>
                    <span class="font-weight-bold">Ultimi prodotti inseriti</span>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in latest_products %}
                            <tr>
                                <td>{{ product.name }}</td>
                                <td>{{ product.category }}</td>
                                <td>{{ product.date_add|date('d/m/Y') }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="3" class="text-center">Nessun prodotto recente</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Prodotti più venduti -->
        <div class="grow">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-0 d-flex align-items-center">
                    <span class="material-icons mr-2 text-danger">trending_up</span>
                    <span class="font-weight-bold">Prodotti più venduti</span>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Vendite</th>
                                <th>Categoria</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in top_selling_products %}
                            <tr>
                                <td>{{ product.name }}</td>
                                <td>{{ product.sales }}</td>
                                <td>{{ product.category }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="3" class="text-center">Nessuna vendita recente</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="card-body d-flex justify-content-between align-items-center gap-4">
        <!-- Grafico andamento vendite -->
        <div class="grow">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-0 d-flex align-items-center">
                    <span class="material-icons mr-2 text-primary">show_chart</span>
                    <span class="font-weight-bold">Andamento vendite prodotti</span>
                </div>
                <div class="card-body">
                    <canvas id="salesTrendChart" height="160"></canvas>
                </div>
            </div>
        </div>
        <!-- Grafico ripartizione categorie -->
        <div class="grow">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-0 d-flex align-items-center">
                    <span class="material-icons mr-2 text-success">pie_chart</span>
                    <span class="font-weight-bold">Ripartizione prodotti per categoria</span>
                </div>
                <div class="card-body">
                    <canvas id="categoryPieChart" height="160"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Chart.js: dati passati dal controller Twig ---
    var salesTrendCtx = document.getElementById('salesTrendChart').getContext('2d');
    var salesTrendChart = new Chart(salesTrendCtx, {
        type: 'line',
        data: {
            labels: {{ sales_trend.labels|json_encode|raw }},
            datasets: [{
                label: 'Vendite',
                data: {{ sales_trend.data|json_encode|raw }},
                backgroundColor: 'rgba(33,150,243,0.2)',
                borderColor: 'rgba(33,150,243,1)',
                borderWidth: 2,
                pointRadius: 3,
                fill: true
            }]
        },
        options: {
            legend: { display: false },
            responsive: true,
            scales: {
                yAxes: [{ ticks: { beginAtZero: true } }]
            }
        }
    });

    var categoryPieCtx = document.getElementById('categoryPieChart').getContext('2d');
    var categoryPieChart = new Chart(categoryPieCtx, {
        type: 'doughnut',
        data: {
            labels: {{ category_distribution.labels|json_encode|raw }},
            datasets: [{
                data: {{ category_distribution.data|json_encode|raw }},
                backgroundColor: [
                    'rgba(76,175,80,0.7)',
                    'rgba(255,193,7,0.7)',
                    'rgba(244,67,54,0.7)',
                    'rgba(33,150,243,0.7)',
                    'rgba(156,39,176,0.7)',
                    'rgba(255,87,34,0.7)'
                ]
            }]
        },
        options: {
            legend: { position: 'bottom' },
            responsive: true
        }
    });
</script>
