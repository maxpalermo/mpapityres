<!-- Modal Dialog -->
<div class="modal fade" id="systemProgressDialog" tabindex="-1" role="dialog" aria-labelledby="systemProgressDialogLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 shadow-lg rounded">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title text-light" id="systemProgressDialogLabel">
                    <i class="material-icons align-middle mr-2">info</i>
                    <span id="systemProgressDialogTitle">Messaggio di Sistema</span>
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Chiudi">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form autocomplete="off">
                <div class="modal-body">
                    <div id="systemProgressDialogMessage" class="mb-3">
                        <!-- Messaggio dinamico -->
                        Operazione in corso, attendere prego...
                    </div>
                    <div class="progress" style="height: 24px;" id="systemProgressDialogProgress">
                        <div id="systemProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            <span id="systemProgressBarPercent" class="font-weight-bold"></span>
                        </div>
                    </div>
                    <div id="systemProgressDialogWaiting" class="mt-3 d-flex justify-content-center align-items-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btnAbort">Chiudi</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    #systemProgressDialog .modal-content {
        border-radius: 1.2rem !important;
        padding: 0 !important;
    }

    #systemProgressDialog .modal-dialog {
        border-radius: 1.2rem !important;
        overflow: hidden;
    }

    #systemProgressDialog .modal-header {
        border-top-left-radius: 1.2rem !important;
        border-top-right-radius: 1.2rem !important;
        border-bottom-left-radius: 0 !important;
        border-bottom-right-radius: 0 !important;
        margin-bottom: 0 !important;
        border-bottom: none !important;
        padding-bottom: 0.5rem !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        background-clip: border-box !important;
        padding: 2rem !important;
    }

    #systemProgressDialog .modal-footer {
        border-radius: 0 0 1.2rem 1.2rem !important;
    }

    #systemProgressDialog .modal-content {
        border-radius: 1.2rem !important;
        padding-top: 0 !important;
    }

    #systemProgressBar {
        border-radius: 1.2rem !important;
    }

    #systemProgressDialogWaiting {
        display: none;
    }
</style>

<script type="text/javascript">
    let ProgressDialogAbortController = null;
    let ProgressDialogAbortSignal = null;

    function updateSystemDialogMessage(message) {
        document.getElementById('systemProgressDialogMessage').innerHTML = message;
    }

    function updateSystemDialogTitle(title) {
        document.getElementById('systemProgressDialogTitle').innerHTML = title;
    }

    function showSystemDialog(title, message, waiting = false) {
        updateSystemDialogTitle(title);
        updateSystemDialogMessage(message);
        updateProgressBar(0);
        $('#systemProgressDialog').modal({
            backdrop: 'static',
            keyboard: false
        });
        if (waiting) {
            showSpinner();
            hideProgressBar();
        }
    }

    function hideProgressBar()
    {
        $("#systemProgressDialogWaiting div.spinner-border").hide();
    }

    function hideSpinner()
    {
        $("#systemProgressDialogWaiting div.spinner-border").hide();
    }

    function showProgressBar()
    {
        $("#systemProgressDialogProgress").show();
    }

    function showSpinner()
    {
        $("#systemProgressDialogWaiting div.spinner-border").show();
    }

    function hideSystemDialog() {
        $("#systemProgressDialogWaiting div.spinner-border").hide();
        $("#systemProgressDialogProgress").show();
        $('#systemProgressDialog').modal('hide');
    }

    function updateProgressBar(percent) {
        var bar = document.getElementById('systemProgressBar');
        var percentSpan = document.getElementById('systemProgressBarPercent');
        bar.style.width = percent + '%';
        bar.setAttribute('aria-valuenow', percent);
        percentSpan.innerHTML = percent + '%';
        if (percent === 100) {
            bar.classList.remove('bg-success');
            bar.classList.add('bg-info');
            percentSpan.innerHTML = "Completato!";
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        // Demo di utilizzo
        document.body.insertAdjacentHTML(
            'beforeend',
            `
                <button id="demoDialogBtn" class="btn btn-primary" style="position:fixed;bottom:32px;right:32px;z-index:2000;">
                    <i class="material-icons align-middle">play_circle_filled</i> Demo Dialog
                </button>
            `,
        );

        document.getElementById('demoDialogBtn').addEventListener('click', function() {
            showSystemDialog('Elaborazione dati', 'Stiamo processando i dati. Attendere il completamento...');
            let progress = 0;
            let interval = setInterval(function() {
                progress += Math.floor(Math.random() * 8) + 4; // Progresso random simulato
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    setTimeout(() => hideSystemDialog(), 1200);
                }
                updateProgressBar(progress);
            }, 400);
        });

        const btnAbort = document.getElementById('btnAbort');
        btnAbort.addEventListener('click', function() {
            if (ProgressDialogAbortController) {
                //Invia il segnale di abort
                ProgressDialogAbortController.abort();
                console.log("Abort signal sent");
            }
        });
    });
</script>