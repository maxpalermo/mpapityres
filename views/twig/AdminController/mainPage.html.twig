<style>
    .form-inline {
        display: flex !important;
        justify-content: start !important;
        align-items: top !important;
        gap: 0.5rem !important;
    }

    .btn {
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        gap: 0.5rem;
    }

    .mb-3 {
        margin-bottom: 1.5rem !important;
    }

    .progress-bar-striped {
    background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
    background-size: 1rem 1rem;
    }

    .progress-bar-animated {
        -webkit-animation: progress-bar-stripes 1s linear infinite;
        animation: progress-bar-stripes 1s linear infinite;
    }
</style>

<!-- Template progress bar download -->
<template id="template-download-container">
    <div class="download-container">
        <button id="start-download" onclick="startDownload()">Scarica Catalogo</button>
        
        <div class="progress-container" style="display: none;">
            <div class="progress">
                <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
            <p id="progress-text">0% completato</p>
            <p id="download-speed">Velocità: 0 KB/s</p>
            <p id="download-eta">Tempo rimanente: Calcolo in corso...</p>
            <p id="download-size">Dimensione: 0 B / 0 B</p>
            <p id="download-status"></p>
        </div>
    </div>
</template>

<!-- Pagina principale -->
<div class="bootstrap">
    <div class="row mb-4">
        <div class="col-12">
            <div class="bootstrap panel panel-default">
                <div class="panel-body">
                    <div class="d-flex align-items-center">
                        <i class="material-icons mr-2 text-info">info</i>
                        <div>
                            <p class="mb-1"><strong>Per importare i dati con API Tyre 1.4, segui questi passaggi:</strong></p>
                            <ol class="mb-0">
                                <li>Imposta i filtri di ricerca</li>
                                <li>Clicca sul pulsante "Scarica e crea file JSON" per scaricare i dati e creare il file JSON</li>
                                <li>Clicca sul pulsante "Aggiorna catalogo Prestashop" per creare il catalogo</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sezione Download ZIP con progresso -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="bootstrap panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title d-flex align-items-center">
                        <i class="material-icons mr-2">cloud_download</i>
                        Download Catalogo ZIP (con progresso)
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="form-inline mb-3" style="gap: 1rem">
                        <input type="text" id="zip-endpoint" class="form-control" style="width: 60%" placeholder="Incolla qui l'endpoint ZIP da scaricare" value="{{ csvEndpointUrl }}">
                        <button type="button" class="btn btn-primary" id="btn-download-zip">
                            <i class="material-icons mr-2">cloud_download</i>
                            Avvia Download ZIP
                        </button>
                    </div>
                    <div class="progress" style="height: 24px; margin-top: 1rem;">
                        <div id="zip-progress-bar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <div class="mt-2">
                        <span id="zip-progress-text">
                            <div class="alert alert-info">
                                <p>In attesa…</p>
                            </div>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sezione Parsing CSV con progresso -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="bootstrap panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title d-flex align-items-center">
                        <i class="material-icons mr-2">article</i>
                        Parsing CSV (con progresso)
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="form-inline mb-3" style="gap: 1rem">
                        <input type="text" id="csv-path" class="form-control" style="width: 60%" placeholder="Percorso CSV (relativo a modules/mpapityres/ o assoluto)">
                        <button type="button" class="btn btn-secondary" id="btn-fill-latest-csv">
                            <i class="material-icons mr-2">history</i>
                            Usa ultimo CSV
                        </button>
                        <button type="button" class="btn btn-primary" id="btn-parse-csv">
                            <i class="material-icons mr-2">play_arrow</i>
                            Avvia Parsing CSV
                        </button>
                        <button type="button" class="btn btn-warning" id="btn-pause-parse">
                            <i class="material-icons mr-2">pause</i>
                            Pausa
                        </button>
                        <button type="button" class="btn btn-danger" id="btn-reset-parse">
                            <i class="material-icons mr-2">restart_alt</i>
                            Reset parsing
                        </button>
                    </div>
                    <div class="progress" style="height: 24px;">
                        <div id="csv-progress-bar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <div class="mt-2">
                        <span id="csv-progress-text">
                            <div class="alert alert-info">
                                <p>In attesa…</p>
                            </div>
                        </span>
                    </div>
                    <div class="mt-2">
                        <span id="csv-inserted-result" class="text-success" style="display:none"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sezione Download Catalogo APi con progresso -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="bootstrap panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title d-flex align-items-center">
                        <i class="material-icons mr-2">download</i>
                        Download Catalogo Tyre tramite API
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="form-inline mb-3" style="gap: 1rem">                        
                        <button type="button" class="btn btn-primary" id="btn-api-download">
                            <i class="material-icons mr-2">play_arrow</i>
                            Avvia Download API
                        </button>
                        <button type="button" class="btn btn-warning" id="btn-api-stop-download">
                            <i class="material-icons mr-2">stop</i>
                            Stop
                        </button>
                    </div>
                    <div class="progress" style="height: 24px;">
                        <div id="api-progress-bar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 100%"></div>
                    </div>
                    <div class="mt-2">
                        <span id="api-progress-text">
                            <div class="alert alert-info">
                                <p>In attesa…</p>
                            </div>
                        </span>
                    </div>
                    <div class="mt-2">
                        <span id="api-inserted-result" class="text-success" style="display:none"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sezione Inserimento Catalogo in Prestashop -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="bootstrap panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title d-flex align-items-center">
                        <i class="material-icons mr-2">refresh</i>
                        Aggiorna Catalogo Prestashop
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="form-inline mb-3" style="gap: 1rem">                        
                        <button type="button" class="btn btn-primary" id="btn-api-update">
                            <i class="material-icons mr-2">play_arrow</i>
                            Aggiorna catalogo Prestashop
                        </button>
                        <button type="button" class="btn btn-warning" id="btn-api-stop-update">
                            <i class="material-icons mr-2">stop</i>
                            Stop
                        </button>
                    </div>
                    <div class="progress" style="height: 24px;">
                        <div id="update-progress-bar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 100%"></div>
                    </div>
                    <div class="mt-2">
                        <span id="update-progress-text">
                            <div class="alert alert-info">
                                <p>In attesa…</p>
                            </div>
                        </span>
                    </div>
                    <div class="mt-2">
                        <span id="update-inserted-result" class="text-success" style="display:none"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="bootstrap panel panel-default">
                <div class="panel-body">
                    <div class="d-flex justify-content-center align-items-center">
                        <div class="btn-group">
                            <button type="button" class="btn btn-primary btn-lg btn-flex" id="btn-fetch-api-json">
                                <i class="material-icons mr-2">cloud_download</i>
                                <span>Scarica Catalogo Tyres via API</span>
                            </button>
                            <button type="button" class="btn btn-success btn-lg btn-flex" id="btn-import-json-catalog">
                                <i class="material-icons mr-2">publish</i>
                                <span>Aggiorna catalogo Prestashop</span>
                            </button>
                            <button type="button" class="btn btn-danger btn-lg btn-flex" id="btn-reload-images">
                                <i class="material-icons mr-2">add_photo_alternate</i>
                                <span>Ricarica tutte le immagini del catalogo</span>
                            </button>
                            <button type="button" class="btn btn-dark btn-lg btn-flex" id="btn-delete-products">
                                <i class="material-icons mr-2">delete</i>
                                <span>Elimina tutti i prodotti Tyre</span>
                            </button>
                            <button type="button" class="btn btn-warning btn-lg btn-flex" id="btn-create-pfu">
                                <i class="material-icons mr-2">create</i>
                                <span>Crea i prodotti PFU</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <template id="template-modal-pfu">
            <dialog class="bootstrap" id="modal-pfu">
                <div class="bootstrap panel">
                    <div class="panel-heading">
                        <h3 class="panel-title">Crea i prodotti PFU</h3>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Totale Prodotti da creare</label>
                                    <input class="form-control" type="number" value="1" id="pfu-total-products">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Codice ID da cui partire</label>
                                    <input class="form-control" type="number" value="10000000" id="pfu-id-start">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Aliquota IVA</label>
                                    <select class="form-control" id="pfu-tax-rules-group">
                                        {% for taxRulesGroup in taxRulesGroups %}
                                            <option value="{{ taxRulesGroup.id_tax_rules_group }}">{{ taxRulesGroup.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Elenco prezzi PFU</label>
                                    <textarea class="form-control" id="pfu-price-list" rows="10"></textarea>
                                    <small class="form-text text-muted">Inserisci un elenco di prezzi PFU, uno per riga.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-footer d-flex justify-content-center align-items-center">
                        <button type="button" class="btn btn-primary" id="btn-create-pfu" onclick="createPFU();">Crea</button>
                    </div>
                </div>
            </dialog>
        </template>

    </div>

    <!-- Sezione dei panel informativi in stile dashboard -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="bootstrap panel panel-info h-100">
                <div class="panel-heading">
                    <h3 class="panel-title">Prodotti Totali</h3>
                </div>
                <div class="panel-body d-flex align-items-center">
                    <i class="material-icons mr-3" style="font-size: 2.5rem">inventory_2</i>
                    <div>
                        <h2 id="products-count" class="display-4 mb-0">{% if summary.products_count is defined %}{{ summary.products_count }}{% else %}0{% endif %}</h2>
                    </div>
                </div>
                <div class="panel-footer text-center">
                    <a href="#" class="text-info">Dettagli</a>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="bootstrap panel panel-success h-100">
                <div class="panel-heading">
                    <h3 class="panel-title">Pneumatici Tyre</h3>
                </div>
                <div class="panel-body d-flex align-items-center">
                    <i class="material-icons mr-3" style="font-size: 2.5rem">euro_symbol</i>
                    <div>
                        <h2 id="products-tyre-count" class="display-4 mb-0">{% if summary.products_tyre_count is defined %}{{ summary.products_tyre_count }}{% else %}0{% endif %}</h2>
                    </div>
                </div>
                <div class="panel-footer text-center">
                    <a href="#" class="text-success">Dettagli</a>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="bootstrap panel panel-warning h-100">
                <div class="panel-heading">
                    <h3 class="panel-title">Produttori</h3>
                </div>
                <div class="panel-body d-flex align-items-center">
                    <i class="material-icons mr-3" style="font-size: 2.5rem">warning</i>
                    <div>
                        <h2 id="manufacturers-count" class="display-4 mb-0">{% if summary.manufacturers_count is defined %}{{ summary.manufacturers_count }}{% else %}0{% endif %}</h2>
                    </div>
                </div>
                <div class="panel-footer text-center">
                    <a href="#" class="text-warning">Dettagli</a>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="bootstrap panel panel-danger h-100">
                <div class="panel-heading">
                    <h3 class="panel-title">Prodotti Disattivati</h3>
                </div>
                <div class="panel-body d-flex align-items-center">
                    <i class="material-icons mr-3" style="font-size: 2.5rem">block</i>
                    <div>
                        <h2 id="products-disabled" class="display-4 mb-0">{% if summary.products_disabled is defined %}{{ summary.products_disabled }}{% else %}0{% endif %}</h2>
                    </div>
                </div>
                <div class="panel-footer text-center">
                    <a href="#" class="text-danger">Dettagli</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Sezione con informazioni CRON -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="bootstrap panel panel-primary h-100">
                <div class="panel-heading">
                    <h3 class="panel-title">Ultimo CRON - Download Tyre</h3>
                </div>
                <div class="panel-body">
                    <div class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-center">
                            <i class="material-icons mb-3" style="font-size: 3rem">schedule</i>
                            <h3 id="last-fetch-download">{% if summary.last_fetch_download is defined and summary.last_fetch_download %} {{ summary.last_fetch_download|date("d/m/Y H:i") }} {% else %} Mai eseguito {% endif %}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="bootstrap panel panel-primary h-100">
                <div class="panel-heading">
                    <h3 class="panel-title">Ultimo CRON - Import Catalogo</h3>
                </div>
                <div class="panel-body">
                    <div class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-center">
                            <i class="material-icons mb-3" style="font-size: 3rem">schedule</i>
                            <h3 id="last-fetch-import">{% if summary.last_fetch_import is defined and summary.last_fetch_import %} {{ summary.last_fetch_import|date("d/m/Y H:i") }} {% else %} Mai eseguito {% endif %}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="bootstrap panel panel-primary h-100">
                <div class="panel-heading">
                    <h3 class="panel-title">Ultimo CRON - Reload Immagini</h3>
                </div>
                <div class="panel-body">
                    <div class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-center">
                            <i class="material-icons mb-3" style="font-size: 3rem">schedule</i>
                            <h3 id="last-reload-images">{% if summary.last_fetch_reload_images is defined and summary.last_fetch_reload_images %} {{ summary.last_fetch_reload_images|date("d/m/Y H:i") }} {% else %} Mai eseguito {% endif %}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sezione grafici e tabelle -->
    <div class="row mb-4">
        <!-- Grafico andamento importazioni -->
        <div class="col-md-8">
            <div class="bootstrap panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title d-flex align-items-center">
                        <i class="material-icons mr-2">trending_up</i>
                        Andamento Importazioni (Ultimi 12 mesi)
                    </h3>
                </div>
                <div class="panel-body">
                    <canvas id="importChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Grafico distribuzione categorie -->
        <div class="col-md-4">
            <div class="bootstrap panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title d-flex align-items-center">
                        <i class="material-icons mr-2">pie_chart</i>
                        Distribuzione Categorie
                    </h3>
                </div>
                <div class="panel-body">
                    <canvas id="categoryChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Sezione tabelle -->
    <div class="row mb-4">
        <!-- Tabella prodotti più venduti -->
        <div class="col-md-6">
            <div class="bootstrap panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title d-flex align-items-center">
                        <i class="material-icons mr-2">star</i>
                        Prodotti Più Popolari
                    </h3>
                </div>
                <div class="panel-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Prodotto</th>
                                    <th>Visualizzazioni</th>
                                    <th>Valore</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if summary.popular_products is defined and summary.popular_products|length > 0 %} {% for product in summary.popular_products %}
                                <tr>
                                    <td>{{ product.id_product }}</td>
                                    <td>{{ product.name }}</td>
                                    <td>{{ product.views }}</td>
                                    <td>€ {{ product.price|number_format(2, ',', '.') }}</td>
                                </tr>
                                {% endfor %} {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">Nessun dato disponibile</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabella produttori top -->
        <div class="col-md-6">
            <div class="bootstrap panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title d-flex align-items-center">
                        <i class="material-icons mr-2">business</i>
                        Produttori Top
                    </h3>
                </div>
                <div class="panel-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Produttore</th>
                                    <th>Prodotti</th>
                                    <th>Attivi</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if summary.top_manufacturers is defined and summary.top_manufacturers|length > 0 %} {% for manufacturer in summary.top_manufacturers %}
                                <tr>
                                    <td>{{ manufacturer.id_manufacturer }}</td>
                                    <td>{{ manufacturer.name }}</td>
                                    <td>{{ manufacturer.products_count }}</td>
                                    <td>{{ manufacturer.active_products }}</td>
                                </tr>
                                {% endfor %} {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">Nessun dato disponibile</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dati per JavaScript -->
    <script type="text/javascript">
        // URL per le azioni AJAX
        const baseUrl = "{{ baseUrl | raw }}";
        const CronControllerURL = "{{ cronControllerUrl | raw }}"; 
        const AdminControllerUrl = "{{ adminControllerUrl | raw }}";
        const DownloadCatalogActionUrl = "{{ downloadCatalogActionUrl | raw }}";
        const ImportCatalogActionUrl = "{{ importCatalogActionUrl | raw }}";
        const ReloadImagesActionUrl = "{{ reloadImagesActionUrl | raw }}";
        const DeleteProductsActionUrl = "{{ deleteProductsActionUrl | raw }}";
    </script>

    <!-- Dati per i grafici -->
    <script type="text/javascript">
        // Inizializzazione variabili con dati da Twig
        var importHistoryData = {{ summary.import_history is defined ? summary.import_history|json_encode|raw : '[]' }};
        var categoryDistributionData = {{ summary.category_distribution is defined ? summary.category_distribution|json_encode|raw : '[]' }};

        // Oggetto dati per i grafici
        var chartData = {
            importHistory: importHistoryData,
            categoryDistribution: categoryDistributionData
        };
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Inizializzazione grafici se ci sono dati
            if (chartData.importHistory.length > 0) {
                const importCtx = document.getElementById("importChart").getContext("2d");
                new Chart(importCtx, {
                    type: "line",
                    data: {
                        labels: chartData.importHistory.map((item) => item.month),
                        datasets: [
                            {
                                label: "Prodotti Importati",
                                data: chartData.importHistory.map((item) => item.count),
                                borderColor: "rgba(75, 192, 192, 1)",
                                backgroundColor: "rgba(75, 192, 192, 0.2)",
                                tension: 0.4,
                                fill: true,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                    },
                });
            }

            if (chartData.categoryDistribution.length > 0) {
                const categoryCtx = document.getElementById("categoryChart").getContext("2d");
                new Chart(categoryCtx, {
                    type: "pie",
                    data: {
                        labels: chartData.categoryDistribution.map((item) => item.name),
                        datasets: [
                            {
                                data: chartData.categoryDistribution.map((item) => item.count),
                                backgroundColor: ["rgba(75, 192, 192, 0.7)", "rgba(255, 99, 132, 0.7)", "rgba(255, 205, 86, 0.7)", "rgba(54, 162, 235, 0.7)", "rgba(153, 102, 255, 0.7)"],
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                    },
                });
            }
        });
    </script>
</div>
